# [4장] 카프카 상세 개념 설명

# 4.1 토픽과 파티션

- 카프카를 사용하는 것은 토픽을 만들면서 시작이 되며, 토픽을 삭제하면 데이터는 삭제되고 파이프라인은 중단된다.

## 4.1.1 적정 파티션 개수

- 토픽의 파티션 개수는 카프카의 성능과 관련이 있기에 토픽을 운영함에 있어 적절한 파티션 개수를 설정하고 운영하는 것이 매우 중요하다.

> **토픽 생성 시 파티션 개수 고려사항**

1. 데이터 처리량

    ![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/92463825-2a0b-4658-bc67-4ed33b048279/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082830Z&X-Amz-Expires=86400&X-Amz-Signature=371897d0cc4b74c7577dd00ab607a16f1054c9954188441256cc03d4025804c6&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

2. 메시지 키 사용 여부

    ![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%201.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/86a455cb-25ed-4921-a924-8367b1f14736/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082837Z&X-Amz-Expires=86400&X-Amz-Signature=78f839d1e26fc3d01327cb78ea43c79dee1dd38d347a6f307a10c6a286727132&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

3. 브로커, 컨슈머 영향도

## 4.1.2 토픽 정리 정책(cleanup.policy)

- 토픽의 데이터는 시간 또는 용량에 따라 삭제 규칙을 적용할 수 있다.
- 데이터를 더는 사용하지 않을 경우에는 cleanup.policy 옵션을 사용하여 데이터를 삭제할 수 있는데, cleanup.policy 옵션은 delete, compact 두 가지 삭제 정책을 제공한다.

### 토픽 삭제 정책 (delete policy)

- 토픽의 데이터를 삭제
- 세그먼트 단위로 삭제를 진행한다.
- 삭제 정책이 실행되는 시점은 시간 또는 용량이 기준이 된다. (retention.ms → 토픽의 데이터를 유지하는 기간 / retention.bytes → 토픽의 최대 데이터 크기)
- 삭제된 데이터는 복구할 수 없다.

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%202.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/585a8b1e-e21a-493a-8b36-1f3bdf495e6d/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082841Z&X-Amz-Expires=86400&X-Amz-Signature=a68d2764f0cd2ca13890d9f41c05b6acac83fd0720c3c28f296cf47faf84844c&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

### 토픽 압축 정책 (compact policy)

- 메시지 키 별로 해당 메시지 키의 레코드 중 오래된 데이터를 삭제하는 정책
- 카프카 스트림즈의 KTable과 같이 메시지 키를 기반으로 데이터를 처리할 경우 유용하다.
- 액티브 세그먼트를 제외한 나머지 세그먼트들에 한해서만 데이터를 처리한다.
- min.cleanable.dirty.ratio → 데이터의 압축 시작 시점 결정

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%203.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/7e73dbc5-c4fd-4bd2-b92e-a8f6435a2968/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082846Z&X-Amz-Expires=86400&X-Amz-Signature=a7130966295b35e04f821a032385bb306460a76665998d6f372286a7c990b122&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%204.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/1b492727-da91-4a62-ada9-4a3c60b14ee6/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082851Z&X-Amz-Expires=86400&X-Amz-Signature=28948e0d0a61d7e754aaf1505a162321308dacf6f11e56ef4495a07822ff62fd&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

## 4.1.3 ISR(In-Sync-Replicas)

- 리더 파티션과 팔로워 파티션이 모두 싱크가 된 상태
- ISR이라는 용어가 나온 이유는 팔로워 파티션이 리더 파티션으로부터 데이터를 복제하는 데에 시간이 걸리기 때문이다.
- 이러한 시간차 때문에 리더 파티션과 팔로워 파티션 간에 오프셋 차이가 발생한다.
- 이런 차이를 모니터링하기 위해 리더 파티션은 replica.lag.time.max.ms값 만큼의 주기를 가지고 팔로워 파티션이 데이터를 복제하는지 확인한다.
- ISR로 묶인 팔로워 파티션은 리더 파티션으로 새로 선출될 자격을 가진다.
- 일부 데이터 유실이 발생하더라도 지속적으로 토픽을 사용하고 싶다면 unclean.leader.election.enable 옵션을설정하여 ISR이 아닌 팔로워 파티션을 리더 파티션으로 선출 가능하도록 할 수 있다.

```bash
$ bin/kafka-topics.sh --bootstrap-server my-kafka:9092 \
--create --topic my-topic \
--config unclean.leader.election.enable=false
```

# 4.2 카프카 프로듀서

- 데이터 유실을 막기 위해서는 프로듀서에서 제공하는 다양한 옵션을 함께 사용해야 한다.

## 4.2.1 acks 옵션

- 0, 1, all(또는 -1) 값을 가질 수 있다.
- 이 옵션을 통해 프로듀서가 전송한 데이터가 카프카 클러스터에 얼마나 신뢰성 높게 저장할지 지정할 수 있다.
- 복제 개수가 1인 경우 acks 옵션에 따른 성능 변화는 크지 않다.

### acks = 0

- 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션으로 데이터가 저장되었는지 확인하지 않는다.
- 이 경우, 프로듀서와 브로커 사이의 네트워크 오류나 브로커의 이슈 등으로 인해 데이터가 유실되더라도 프로듀서는 리더 파티션으로부터 응답값을 받지 않기 때문에 지속적으로 다음 데이터를 보낸다.
- 데이터 전송 속도는 매우 빠르다.

### acks = 1

- 프로듀서가 보낸 데이터가 리더 파티션에만 정상적으로 적재되었는지 확인한다.
- 팔로워 파티션이 데이터를 복제하기 직전에 리더 파티션이 있는 브로커에 장애가 발생하면 동기화되지 못한 일부 데이터가 유실될 수 있다.
- 리더 파티션에 데이터가 적재될 때까지 기다린 뒤 응답 값을 받기 때문에 acks=0에 비해 전송 속도가 느리다.

### acks=all 또는 acks=-1

- 프로듀서가 보낸 데이터가 리더 파티션과 팔로워 파티션에 모두 정상적으로 적재되었는지 확인한다.
- 데이터 전송 속도가 가장 느리다.
- 안전하게 데이터를 전송하고 저장할 수 있음을 보장한다.
- min.insync.replicas 옵션값에 따라 데이터의 안정성이 달라진다. (프로듀서가 리더 파티션과 팔로워 파티션에 데이터가 적재되었는지 확인하기 위한 최소 ISR 그룹의 파티션 개수)
- min.insync.replicas의 옵션값을 2로 설정했을 때부터 acks를 all로 설정하는 의미가 있다.

## 4.2.2 멱등성(idempotence) 프로듀서

- 동일한 데이터를 여러 번 전송하더라도 카프카 클러스터에 단 한 번만 저장된다.
- 프로듀서가 보내는 데이터의 중복 적재를 막기 위해 0.11.0 이후 버전부터는 프로듀서에서 enable.idempotence 옵션을 사용하여 정확히 한 번 전달(exactly once delivery)을 지원한다.
- 멱등성 프로듀서는 기본 프로듀서와 달리 데이터를 브로커로 전달할 때 프로듀서 PID와 시퀀스 넘버를 함께 전달한다.

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%205.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/9485af02-23d0-4ba3-a537-ee5101a86f37/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082859Z&X-Amz-Expires=86400&X-Amz-Signature=5c30a02c59427286a8ce1a633f810fc83504ac8390a0ef6e465cd1287bb09fd1&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

## 4.2.3 트랜잭션(transaction) 프로듀서

- 다수의 파티션에 데이터를 저장할 경우 모든 데이터에 대해 동일한 원자성을 만족시키기 위해 사용된다.
- 다수의 데이터를 동일 트랜잭션으로 묶음으로써 전체 데이터를 처리하거나 전체데이터를 처리하지 않도록 하는 것이다.
- enable.idempotence=true, transactional.id=(임의의 String 값) / (컨슈머) isolation.level=read_committed
- 프로듀서와 컨슈머는 트랜잭션으로 처리 완료된 데이터만 쓰고 읽게 된다.
- 만약 데이터만 존재하고 트랜잭션 레코드가 존재하지 않으면 데이터를 가져가지 않는다.

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%206.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/f4d92a07-040e-4711-a842-20c0ad09fbb5/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082904Z&X-Amz-Expires=86400&X-Amz-Signature=f58ec7341448491080b59f7fc68aa705e87548a6bf7be3046b53ef321c12bda9&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

# 4.3 카프카 컨슈머

## 4.3.1 멀티 스레드 컨슈머

- 카프카는 처리량을 늘리기 위해 파티션과 컨슈머 개수를 늘려서 운영할 수 있다.
- 데이터를 병렬 처리하기 위해 파티션 개수와 컨슈머 개수를 동일하게 맞추는 것이 가장 좋은 방법이다.

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%207.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/ae1fb913-2cbc-4ac6-8124-34b38a37ea24/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082908Z&X-Amz-Expires=86400&X-Amz-Signature=9634413a498aaf05d6d3bbba66ab9f4cc3c1c51b67fe4db447ad1ea65946341d&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

- 멀티 스레드 애플리케이션으로 개발할 경우 하나의 프로세스 내부에 스레드가 여러 개 생성되어 실행되기 때문에 하나의 컨슈머 스레드에서 예외적 상황이 발생할 경우 프로세스 자체가 종료될 수 있고 이는 다른 컨슈머 스레드에까지 영향을 미칠 수 있다.
- 멀티 컨슈머 스레드 애플리케이션을 안정적으로 지속 운영할 수 있도록 개발한다면 효율적으로 컨슈머를 운영할 수 있다.
- 멀티 스레드 컨슈머 활용 방식
    1. 워커 스레드 전략: 컨슈머 스레드 1개 실행, 데이터 처리를 담당하는 워커 스레드를 여러 개 실행

        ![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%208.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/4ccaa038-201a-416a-bf3f-0a914dd16508/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082913Z&X-Amz-Expires=86400&X-Amz-Signature=15ef1454bf054aa6f44e300d61a192ca206bc0a7ac7e01bada959a3bb096dd7d&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

    2. 컨슈머 멀티 스레드 전략: 컨슈머 인스턴스에서 poll() 메서드를 호출하는 스레드를 여러 개 띄워서 사용

        ![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%209.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/f6f7626e-5978-4b63-ae9c-a3c3adc3a6f1/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082916Z&X-Amz-Expires=86400&X-Amz-Signature=f8e365fb2284fa11b7ef8e9d7bcdaa4b30934d47a28aa99114907c0a2442c1a9&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

## 4.3.2 컨슈머 랙 (LAG)

- 토픽의 최신 오프셋과 컨슈머 오프셋 간의 차이
- 컨슈머 랙은 컨슈머가 정상 동작하는지 여부를 확인할 수 있기 때문에 컨슈머 애플리케이션을 운영한다면 필수적으로 모니터링해야 하는 지표이다.
- 컨슈머 랙은 컨슈머 그룹과 토픽, 파티션 별로 생성한다.

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%2010.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/ee44db3f-9675-41e6-b3b0-a6f13104e28f/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082921Z&X-Amz-Expires=86400&X-Amz-Signature=0007817073160359089285c684e6c3bc55fbbeda5de0801bf8cb1d2e15b5a7cf&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%2011.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/a6cb9e52-4d31-4d8f-bc2f-96541739f01c/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082925Z&X-Amz-Expires=86400&X-Amz-Signature=eee41afeb1706fc207607a6cd0e477685f4f6a8f8af5c07678d73af0d227f782&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%2012.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/0b290e8e-2e03-431f-893b-61464284e392/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082931Z&X-Amz-Expires=86400&X-Amz-Signature=562a3172212b6b325bce179a81a108a4221d8eb6ebfb5057f6442d14a53df1dd&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%2013.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/f2d34f72-8c61-4117-8af7-ad29bca080df/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082937Z&X-Amz-Expires=86400&X-Amz-Signature=2f5298854caaa07484b8a30000f41148e61a7714fb2adeb23ecf521cf8924ad7&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

![%5B4%E1%84%8C%E1%85%A1%E1%86%BC%5D%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%89%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A6%20%E1%84%80%E1%85%A2%E1%84%82%E1%85%A7%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%86%E1%85%A7%E1%86%BC%2014fbb485b9e448e7be428eaa357df4e9/Untitled%2014.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/c58b3bad-3c00-468c-a246-63e3381c8c0b/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAT73L2G45O3KS52Y5%2F20210808%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20210808T082942Z&X-Amz-Expires=86400&X-Amz-Signature=c0ae3d136192d269857fdfdea749663d4ce4ece2630823fdb3a9cd39d8baa5ac&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22)

## 4.3.3 컨슈머 배포 프로세스

- 서비스의 지속적인 발전을 위해 애플리케이션 내부 로직의 변경과 배포는 필수적이다.
- 카프카 컨슈머 애플리케이션 운영 시 로직 변경으로 인한 배포를 하는 방법
    1. 중단 배포
        - 짧은 시간 동안 중단이 되어 지연이 발생하더라도 서비스 운영에 이슈가 없을 경우 사용
        - 컨슈머 애플리케이션을 완전히 종료한 이후에 개선된 코드를 가진 애플리케이션을 배포
    2. 무중단 배포
        - 중단이 발생하면 서비스에 영향이 클 경우 사용
        - 컨슈머의 중단이 불가능한 애플리케이션의 신규 로직 배포가 필요할 경우 무중단 배포가 필요
        - 인스턴스의 발급과 반환이 다소 유연한 가상 서버를 사용하는 경우에 유용
        - 3가지 방법 → 블루/그린, 롤링, 카나리 배포

# 4.4 스프링 카프카

- 카프카를 스프링 프레임워크에서 효과적으로 사용할 수 있도록 만들어진 라이브러리
- 스프링 카프카 라이브러리를 스프링 부트 프레임워크와 함께 사용하기 위해서는 다음과 같이 build.gradle에 디펜던시를 추가한다.

```bash
dependencies {
	compile 'org.springframework.kafka:spring-kafka:2.5.10.RELEASE'
	compile 'org.springframework.boot:spring-boot-starter:2.4.0'
}
```

## 4.4.1 스프링 카프카 프로듀서

- '카프카 템플릿(Kafka Template)'이라고 불리는 클래스를 사용하여 데이터를 전송
- 카프카 템플릿은 ProducrFactory 클래스를 통해 생성할 수 있다.
- 카프카 템플릿 사용 방법
    1. 스프링 카프카에서 제공하는 기본 카프카 템플릿 사용
    2. 직접 사용자가 카프카 템플릿을 프로듀서 팩토리로 생성

## 4.4.2 스프링 카프카 컨슈머

- 스프링 카프카의 컨슈머는 기존 컨슈머를 2개의 타입으로 나누고 커밋을 7가지로 나누어 세분화했다.
- 레코드 리스너: 단 1개의 레코드 처리
    - MessageListener
    - AcknowledgingMessageListener
    - ConsumerAwareMessageListener
    - AcknowledgingConsumerAwareMessageListener
- 배치 리스너: 한 번에 여러 개 레코드 처리
    - BatchMessageListener
    - BatchAcknowledgingMessageListener
    - BatchConsumerAwareMessageListener
    - BatchAcknowledgingConsumerAwareMessageListener
- 스프링 카프카 커밋 종류

    → RECORD, BATCH, TIME, COUNT, COUNT_TIME, MANUAL, MANUAL_IMMEDIATE

- 리스너를 생성하고 사용하는 방식
    1. 기본 리스너 컨테이너를 사용
    2. 컨테이너 팩토리를 사용하여 직접 리스너 생성